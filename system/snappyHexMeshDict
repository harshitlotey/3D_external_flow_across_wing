/*--------------------------------*- C++ -*----------------------------------*\
  =========                 |
  \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox
   \\    /   O peration     | Website:  https://openfoam.org
    \\  /    A nd           | Version:  13
     \\/     M anipulation  |
\*---------------------------------------------------------------------------*/
FoamFile
{
    format      ascii;
    class       dictionary;
    object      snappyHexMeshDict;
}
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //

// #includeEtc "caseDicts/mesh/generation/snappyHexMeshDict.cfg"

castellatedMesh on;
snap            on;
addLayers       on;

geometry
{
    inlet1{ type triSurfaceMesh; file "inlet1.stl";}
    inlet2{ type triSurfaceMesh; file "inlet2.stl";}
    outlet1{ type triSurfaceMesh; file "outlet1.stl";}
    wall1{ type triSurfaceMesh; file "wall1.stl";}
    // symmetry1{ type triSurfaceMesh; file "symmetry1.stl";}
    wake1 {type searchableBox; min (-0.1 -0.15 -0.9); max (2.0 0.15 0.1);}
    wake2 {type searchableBox; min (1.9 -0.2 -1); max (5.1 0.2 0.1);}
    // vertical {type searchableBox; min (-0.2 -2.2 -1); max (0.5 2.2 0.2);}
    // buffer1 {type searchableBox; min (-0.5 -0.25 -0.5); max (0.6 0.25 0);}
    buffer2 {type searchableBox; min (-1 -0.5 -1); max (1 0.5 0);}
    symmetryZone
    {
        type searchableBox;
        min (-0.5 -0.5 -0.05); // Slightly larger than domain, just below Z=0
        max ( 0.5  0.5  0.05); // Straddling the Z=0 plane
    }
}

castellatedMeshControls
{
    maxLocalCells 1000000;
    maxGlobalCells 30000000;
    minRefinementCells 0;
    maxLoadUnbalance 0.10;
    nCellsBetweenLevels 3;
    resolveFeatureAngle 15;
    allowFreeStandingZoneFaces false;
    features
    (
        { file "inlet1.eMesh"; level 0;}
        { file "inlet2.eMesh"; level 0;}
        { file "outlet1.eMesh"; level 0;}
        { file "wall1.eMesh"; level 6;}
        // { file "symmetry1.eMesh"; level 0;}
    );

    refinementSurfaces
    {
        inlet1{ level (0 0); patchInfo{type patch;}}
        inlet2{ level (0 0); patchInfo{type patch;}}
        outlet1{ level (0 0); patchInfo{type patch;}}
        wall1{ level (5 5); patchInfo{type wall;}}
        // symmetry1{ level (0 0); patchInfo{type symmetry;}}
    }

    refinementRegions
    {
        wake1 {mode inside; level 3;}
        wake2 {mode inside; level 2;}
        // vertical {mode inside; level 2;}
        // buffer1 {mode inside; level 3;}
        buffer2 {mode inside; level 2;}
        wall1
        {
            mode distance;
            levels ((0.003 6)); 
        }
        // symmetry1
        // {
        //     mode distance;
        //     levels ((0.01 3));
        // }
        symmetryZone
        {
            mode inside;
            level 3; // Refine cells inside this thin layer to Level 3
        }
    }

    insidePoint (0.5 0.5 -0.5);
}

snapControls
{
    nSmoothPatch 5;
    tolerance 4.0;
    nSolveIter 200;
    nRelaxIter 20;
    nFeatureSnapIter 20;
    implicitFeatureSnap false;
    explicitFeatureSnap true;
    multiRegionFeatureSnap true;
}

addLayersControls
{
    layers
    {
        wall1{nSurfaceLayers 12;}
    }
    relativeSizes false;
    expansionRatio 1.3;
    firstLayerThickness 0.00001766;
    minThickness 1e-7;
    nGrow 0;
    featureAngle 180;
    nRelaxIter 10;
    nSmoothSurfaceNormals 10;
    nSmoothNormals 3;
    nSmoothThickness 10;
    maxFaceThicknessRatio 0.7;
    maxThicknessToMedialRatio 0.6;
    minMedialAxisAngle 65;
    nBufferCellsNoExtrude 0;
    nLayerIter 50;//50;
}

meshQualityControls
{
    maxNonOrtho 75;
    maxBoundarySkewness 20;
    maxInternalSkewness 4;
    maxConcave 80;
    minVol 1e-13;
    minTetQuality -1;
    minArea -1;
    minTwist 0.01;
    minDeterminant 0.001;
    minFaceWeight 0.05;
    minVolRatio 0.01;
    minTriangleTwist -1;
    nSmoothScale 4;
    errorReduction 0.75;
    relaxed
    {
        maxNonOrtho 75;
    }
}

writeFlags
(
//    scalarLevels
    layerSets
    layerFields
);

mergeTolerance 1e-6;

// ************************************************************************* //
